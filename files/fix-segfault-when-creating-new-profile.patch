From 247f2bd973bb24041363c74d560883dcfea86d64 Mon Sep 17 00:00:00 2001
From: Tasos Sahanidis <tasos@tasossah.com>
Date: Fri, 25 Dec 2020 16:25:14 +0200
Subject: [PATCH] Fix segfault when creating new profile

---
 src/gui/kb.cpp              | 8 ++++++++
 src/gui/kb.h                | 2 +-
 src/gui/kbprofiledialog.cpp | 2 +-
 3 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/src/gui/kb.cpp b/src/gui/kb.cpp
index ff24ce08..a6231404 100644
--- a/src/gui/kb.cpp
+++ b/src/gui/kb.cpp
@@ -808,6 +808,14 @@ void Kb::setCurrentMode(KbMode* mode){
     mode->light()->forceFrameUpdate();
 }
 
+KbProfile* Kb::newProfileWithBlankMode(){
+    KbProfile* p = new KbProfile(this, getKeyMap());
+    KbMode* m = newMode();
+    p->append(m);
+    p->currentMode(m);
+    return p;
+}
+
 KeyMap::Layout Kb::getCurrentLayout(){
     return _layout;
 }
diff --git a/src/gui/kb.h b/src/gui/kb.h
index 32c3dada..bfdda7f9 100644
--- a/src/gui/kb.h
+++ b/src/gui/kb.h
@@ -76,7 +76,7 @@ class Kb : public QThread
     void        setCurrentMode(KbMode* mode);
 
     // Create a new profile/mode. The newly-created object will NOT be inserted into the current profile/mode list.
-    inline KbProfile*   newProfile()                                  { return new KbProfile(this, getKeyMap()); }
+    KbProfile*   newProfileWithBlankMode();
     inline KbProfile*   newProfile(KbProfile* other)                  { return new KbProfile(this, getKeyMap(), *other); }
     inline KbProfile*   newProfile(CkbExternalSettings* settings, QString guid) { return new KbProfile(this, getKeyMap(), *settings, guid); }
     inline KbMode*      newMode()                                     { return new KbMode(this, getKeyMap()); }
diff --git a/src/gui/kbprofiledialog.cpp b/src/gui/kbprofiledialog.cpp
index d90b268d..175393cf 100644
--- a/src/gui/kbprofiledialog.cpp
+++ b/src/gui/kbprofiledialog.cpp
@@ -85,7 +85,7 @@ void KbProfileDialog::on_profileList_itemClicked(QListWidgetItem *item){
         item->setFont(font);
         item->setIcon(QIcon(":/img/icon_profile.png"));
         // Add the new profile and assign it to this item
-        KbProfile* newProfile = device->newProfile();
+        KbProfile* newProfile = device->newProfileWithBlankMode();
         device->appendProfile(newProfile);
         item->setData(GUID, newProfile->id().guid);
         item->setData(NEW_FLAG, 0);
